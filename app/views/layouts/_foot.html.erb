<script>
  window.JSON || document.write('<%= (javascript_include_tag "#{js_base_url}/vendor/json2.js").gsub("</script>", "<\\/script>") %>');

  INST = <%= raw(inst_env.to_json) %>;
  ENV = <%= raw js_env.to_json %>;

  // TODO: move this out when we have a single require call
  require = {
    translate: <%= use_optimized_js? %>,
    baseUrl: '<%= js_base_url %>',
    paths: {
      common: 'compiled/bundles/common',
      jqueryui: 'vendor/jqueryui',
      uploadify: '../flash/uploadify/jquery.uploadify.v2.1.4',
      use: 'vendor/use'
    },
    use: {
      'vendor/backbone': {
        deps: ['underscore', 'jquery'],
        attach: function(_, $){
          return Backbone;
        }
      },

      // slick grid shim
      'vendor/slickgrid/lib/jquery.event.drag-2.0.min': {
        deps: ['jquery'],
        attach: '$'
      },
      'vendor/slickgrid/slick.core': {
        deps: ['jquery', 'use!vendor/slickgrid/lib/jquery.event.drag-2.0.min'],
        attach: 'Slick'
      },
      'vendor/slickgrid/slick.grid': {
        deps: ['use!vendor/slickgrid/slick.core'],
        attach: 'Slick'
      },
      'vendor/slickgrid/slick.editors': {
        deps: ['use!vendor/slickgrid/slick.core'],
        attach: 'Slick'
      },
      'vendor/slickgrid/plugins/slick.rowselectionmodel': {
        deps: ['use!vendor/slickgrid/slick.core'],
        attach: 'Slick'
      }
    }
  };
</script>

<%= javascript_include_tag "#{js_base_url}/vendor/require.js" %>
<%= javascript_include_tag "#{js_base_url}/compiled/bundles/common" if include_common_bundle %>
<%= include_js_bundles %>
<%= include_account_js %>
<%= render_js_blocks %>
<%= render_hidden_dialogs %>

<script>
// Determines if the scripts are loaded.
// When we get everything out of the views, and have a single top-level
// `require`, this becomes meaningless and will be abandoned.
(function() {
  var attempts = 0;
  var timeout = 10;
  var check = function() {
    attempts++;
    var done = require.resourcesDone === true
    var giveup = attempts === 100; // 1 second
    if (done || giveup) {
      var className = document.documentElement.className;
      document.documentElement.className = className.replace(/scripts-not-loaded/, '');
      return;
    }
    setTimeout(check, timeout);
  };

  check();
}).call(this);
</script>
</body>
</html>
